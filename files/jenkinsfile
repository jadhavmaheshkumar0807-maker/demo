pipeline {
    agent any
    
    stages {
        stage('Clone GitHub Repo') {
            steps {
                git branch: 'main', url: 'https://github.com/jadhavmaheshkumar0807-maker/demo.git'
            }
        }

        stage('Build Artifact with Maven') {
            steps {
                sh 'cd mahesh-app && mvn clean package -DskipTests'
            }
        }

        stage('SonarQube Scan') {
            steps {
                sh '''
                    cd mahesh-app
                    mvn sonar:sonar \
                      -Dsonar.host.url=http://3.231.33.88:9000/ \
                      -Dsonar.login=squ_a5f2c6b5bec5dc7e158192870f21233ef6f515bc
                '''
            }
        }

        stage('Build Docker Image') {
            steps {
                sh 'cd mahesh-app && docker build -t maheshkumar010/mahesh:${BUILD_NUMBER} .'
            }
        }

        stage('Scan Docker Image') {
            steps {
                sh 'trivy image maheshkumar010/mahesh:${BUILD_NUMBER} || true'
            }
        }

        stage('Push Docker Image to DockerHub') {
            steps {
                withCredentials([string(credentialsId: 'dockerhub', variable: 'DOCKER_PASSWORD')]) {
                    sh '''
                        echo "${DOCKER_PASSWORD}" | docker login -u maheshkumar010 --password-stdin
                        docker push maheshkumar010/mahesh:${BUILD_NUMBER}
                    '''
                }
            }
        }

        stage('Update Helm Values File') {
            environment {
                GIT_USER_NAME = "jadhavmaheshkumar0807-maker"
                GIT_REPO_NAME = "demo"
            }
            steps {
                withCredentials([string(credentialsId: 'githubtoken', variable: 'githubtoken')]) {
                    sh '''
                        git config user.name "Mahesh Kumar"
                        git config user.email "maheshkumar@gmail.com"

                        sed -i 's|mahesh:.*|mahesh:${BUILD_NUMBER}|g' helm/templates/deployment.yaml


                        git add .
                        git commit -m "Updating imageVersion to ${BUILD_NUMBER}" || echo "No changes to commit"
                        git push https://${githubtoken}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:main
                    '''
                }
            }
        }

        stage('Deploy to EKS using Helm via Ansible') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'aws-creds'
                ]]) {
                    ansiblePlaybook(
                        credentialsId: "ssh",
                        disableHostKeyChecking: true,
                        installation: 'ansible',
                        inventory: '/etc/ansible/inventory',
                        playbook: 'files/Ansible_helm_playbook.yaml',
                        extras: "--extra-vars 'aws_access_key=${AWS_ACCESS_KEY_ID} aws_secret_key=${AWS_SECRET_ACCESS_KEY} build_number=${BUILD_NUMBER}'"
                        )

                }
            }
        }
    }
}
