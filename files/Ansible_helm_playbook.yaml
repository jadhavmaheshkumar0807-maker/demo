---
- hosts: appserver
  name: Deploying application into EKS cluster through Helm
  gather_facts: yes
  become: true

  vars:
    eks_cluster_name: "mahesh"
    eks_region: "us-east-1"
    helm_release_name: "mahesh"
    helm_chart_path: "/home/ec2-user/helm"
    kubeconfig_path: "/home/ec2-user/.kube/config"

    # Temporary for testing â€” REMOVE THESE and use Jenkins Credentials
    aws_access_key: "{{ lookup('env','AWS_ACCESS_KEY_ID') }}"
    aws_secret_key: "{{ lookup('env','AWS_SECRET_ACCESS_KEY') }}"

  tasks:

    - name: Copy Helm chart directory from controller to app server
      copy:
        src: "{{ playbook_dir }}/../helm"
        dest: /home/ec2-user/helm
        mode: '0755'
      tags: copy

    - name: Ensure AWS CLI can fetch EKS kubeconfig
      command: >
        aws eks update-kubeconfig
        --region {{ eks_region }}
        --name {{ eks_cluster_name }}
        --kubeconfig {{ kubeconfig_path }}
      environment:
        AWS_ACCESS_KEY_ID: "{{ aws_access_key }}"
        AWS_SECRET_ACCESS_KEY: "{{ aws_secret_key }}"
        AWS_DEFAULT_REGION: "{{ eks_region }}"
      register: kubeconfig_output

    - name: Show kubeconfig result
      debug:
        var: kubeconfig_output.stdout

    - name: Verify kubectl connection to EKS
      command: kubectl --kubeconfig {{ kubeconfig_path }} get nodes
      environment:
        AWS_ACCESS_KEY_ID: "{{ aws_access_key }}"
        AWS_SECRET_ACCESS_KEY: "{{ aws_secret_key }}"
        AWS_DEFAULT_REGION: "{{ eks_region }}"
      register: nodes_output

    - name: Show node list
      debug:
        var: nodes_output.stdout

    - name: Deploy/Upgrade Helm release on EKS
      command: >
        helm upgrade --install {{ helm_release_name }}
        {{ helm_chart_path }}
        --kubeconfig {{ kubeconfig_path }}
      environment:
        AWS_ACCESS_KEY_ID: "{{ aws_access_key }}"
        AWS_SECRET_ACCESS_KEY: "{{ aws_secret_key }}"
        AWS_DEFAULT_REGION: "{{ eks_region }}"
      register: helm_output

    - name: Show helm output
      debug:
        var: helm_output.stdout
